<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Results â€” MailTrace</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <div class="container">
      <header class="nav">
        <a href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='logo.png') }}" class="logo" alt="MailTrace logo"></a>
      </header>
      <div class="header-accent"></div>

      <h2>Results</h2>
      <div class="grid">
        <div class="card kpi"><div class="k">Mail Rows</div><div class="v">{{ kpis.mail_rows }}</div></div>
        <div class="card kpi"><div class="k">CRM Rows</div><div class="v">{{ kpis.crm_rows }}</div></div>
        <div class="card kpi"><div class="k">Matches</div><div class="v">{{ kpis.matches }}</div></div>
        <div class="card kpi"><div class="k">Match Rate vs Mail</div><div class="v">{{ kpis["match_rate_vs_mail_%"] }}%</div></div>
        <div class="card kpi"><div class="k">Match Rate vs CRM</div><div class="v">{{ kpis["match_rate_vs_crm_%"] }}%</div></div>
        <div class="card kpi"><div class="k">Average Confidence</div><div class="v">{{ kpis["avg_confidence_%"] }}%</div></div>
      </div>

      <form class="actions" action="/download" method="POST">
        <button class="button" type="submit">Download All Matches (CSV)</button>
        <span class="badge">{{ csv_len }} bytes</span>
      </form>

      <div class="card">
        <table>
          <thead>
            <tr>
              {% for c in columns %}<th>{{ c }}</th>{% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
              <tr>
                {% for cell in row %}
                  <td>
                    {% set colname = columns[loop.index0] %}
                    {% if colname == 'match_notes' %}
                      {{ 'none' if (cell|string).lower() in ['','nan','none'] else cell }}
                    {% elif colname == 'confidence_pct' %}
                      {{ (cell|string).rstrip('%') }}%
                    {% else %}
                      {{ '' if (cell|string).lower() in ['nan','none'] else cell }}
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </body>
</html>